//! G-Code Visualizer Panel
//! Displays a 3D visualization of the loaded G-Code toolpath
//! Shows machine position, bounding box, and real-time tool movement

import { ScrollView, VerticalBox, HorizontalBox, Button, GridBox, CheckBox, ComboBox } from "std-widgets.slint";
import { Theme } from "../../gcodekit5-ui/ui/theme.slint";
import { StandardButton, StandardCheckBox, StandardSidebar, StandardTooltip } from "../../gcodekit5-ui/ui/ui_components/shared.slint";

export component GcodeVisualizerPanel inherits Rectangle {
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    background: Theme.sidebar-background;

    in property <string> gcode-filename: "untitled.gcode";
    in property <string> gcode-content: "";
    in property <string> visualization-path-data: "";
    in property <string> visualization-g1-data: "";
    in property <string> visualization-g2-data: "";
    in property <string> visualization-g3-data: "";
    in property <string> visualization-g4-data: "";
    in property <string> visualization-rapid-moves-data: "";
    in property <string> visualization-grid-data: "";
    in property <string> visualization-origin-data: "";
    in property <string> machine-x: "0.000";
    in property <string> machine-y: "0.000";
    in property <string> machine-z: "0.000";
    in property <string> work-x: "0.000";
    in property <string> work-y: "0.000";
    in property <string> work-z: "0.000";
    in property <float> progress: 0.0;
    in property <string> visualizer-status: "Ready";
    in property <float> x-offset: 0.0;
    in property <float> y-offset: 0.0;
    in property <float> zoom-scale: 1.0;
    in property <string> grid-size: "10mm";
    in property <string> bounding-box-info: "";
    in-out property <bool> show-grid: true;
    in-out property <bool> show-spindle: true;
    in-out property <bool> show-rapid-moves: true;
    in-out property <bool> show-cutting-moves: true;
    in-out property <bool> show-intensity: false;
    in-out property <float> max-intensity: 1000.0;
    in property <[string]> visualization-intensity-layers: ["", "", "", "", "", "", "", "", "", ""];
    in property <float> viewbox-x: 0;
    in property <float> viewbox-y: 0;
    in property <float> viewbox-width: 100;
    in property <float> viewbox-height: 100;
    in property <float> machine-x-float: 0.0;
    in property <float> machine-y-float: 0.0;
    out property <float> canvas-width: canvas-rect.width / 1px;
    out property <float> canvas-height: canvas-rect.height / 1px;
    
    // Calculate stroke width for raster layers to simulate 0.25mm beam width
    // This ensures lines scale with zoom and merge correctly
    property <length> raster-stroke-width: (0.25 * (root.canvas-width / root.viewbox-width)) * 1px;
    
    private property <bool> space-pressed: false;
    
    callback refresh-visualization(/* canvas_width */ float, /* canvas_height */ float, /* max_intensity */ float);
    callback zoom-in(/* canvas_width */ float, /* canvas_height */ float);
    callback zoom-out(/* canvas_width */ float, /* canvas_height */ float);
    callback fit-to-view(/* canvas_width */ float, /* canvas_height */ float);
    callback reset-view(/* canvas_width */ float, /* canvas_height */ float);
    callback toggle-grid();
    callback pan-by-mouse(/* dx */ float, /* dy */ float);

    HorizontalLayout {
        spacing: 0px;
        padding: 0px;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEFT SIDEBAR: Controls
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        StandardSidebar {
            VerticalLayout {
                padding: Theme.padding;
                spacing: Theme.spacing;
                alignment: start;

                Text {
                    text: "Visualizer";
                    font-weight: 700;
                    font-size: 14px;
                    color: Theme.text-primary;
                }

                Rectangle { height: 10px; }

                Text {
                    text: "View Controls";
                    font-weight: 700;
                    font-size: 12px;
                    color: Theme.text-secondary;
                }

                HorizontalLayout {
                    spacing: 5px;
                    StandardButton {
                        icon: "ðŸ”„";
                        tooltip: "Refresh";
                        width: 40px;
                        clicked => { root.refresh-visualization(root.canvas-width, root.canvas-height, root.max-intensity); }
                    }
                    StandardButton {
                        icon: "âŠ¡";
                        tooltip: "Fit to View";
                        width: 40px;
                        clicked => { root.fit-to-view(root.canvas-width, root.canvas-height); }
                    }
                    StandardButton {
                        icon: "â†º";
                        tooltip: "Reset View";
                        width: 40px;
                        clicked => { root.reset-view(root.canvas-width, root.canvas-height); }
                    }
                }

                Rectangle { height: 10px; }

                Text {
                    text: "Visibility";
                    font-weight: 700;
                    font-size: 12px;
                    color: Theme.text-secondary;
                }

                StandardCheckBox {
                    text: "Show Spindle/Laser";
                    checked <=> root.show-spindle;
                }

                StandardCheckBox {
                    text: "Show Rapid Moves";
                    checked <=> root.show-rapid-moves;
                }

                StandardCheckBox {
                    text: "Show Cutting Moves";
                    checked <=> root.show-cutting-moves;
                }

                StandardCheckBox {
                    text: "Show Intensity";
                    checked <=> root.show-intensity;
                }

                if root.show-intensity : HorizontalLayout {
                    spacing: 5px;
                    Text {
                        text: "Max S:";
                        vertical-alignment: center;
                        color: Theme.text-secondary;
                        font-size: 12px;
                    }
                    
                    ComboBox {
                        width: 80px;
                        height: 30px;
                        model: [
                            "100", "125", "150", "175", 
                            "200", "225", "250", "275", 
                            "300", "325", "350", "375", 
                            "400", "425", "450", "475", 
                            "500", "525", "550", "575", 
                            "600", "625", "650", "675", 
                            "700", "725", "750", "775", 
                            "800", "825", "850", "875", 
                            "900", "925", "950", "975", 
                            "1000"
                        ];
                        current-value: Math.round(root.max-intensity);
                        selected(value) => {
                            root.max-intensity = value.to-float();
                            root.refresh-visualization(root.canvas-width, root.canvas-height, root.max-intensity);
                        }
                    }
                }

                StandardCheckBox {
                    text: "Show Grid";
                    checked <=> root.show-grid;
                    toggled => { root.toggle-grid(); }
                }
                
                Rectangle { height: 10px; }
                
                if root.bounding-box-info != "": VerticalLayout {
                    spacing: 5px;
                    Text {
                        text: "Bounds";
                        font-weight: 700;
                        font-size: 12px;
                        color: Theme.text-secondary;
                    }
                    Text {
                        text: root.bounding-box-info;
                        font-size: 11px;
                        color: Theme.text-primary;
                        wrap: word-wrap;
                    }
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CENTER: Canvas Area
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            background: Theme.sidebar-item-selected;
            clip: true;

            // Wrap canvas in FocusScope to enable mouse wheel handling if needed later
            canvas-focus := FocusScope {
                width: 100%;
                height: 100%;
                
                key-pressed(event) => {
                    if event.text == " " {
                        root.space-pressed = true;
                        return accept;
                    }
                    reject
                }
                
                key-released(event) => {
                    if event.text == " " {
                        root.space-pressed = false;
                        return accept;
                    }
                    reject
                }

                ScrollView {
                    width: 100%;
                    height: 100%;
                    
                    // Main visualization area
                    canvas-rect := Rectangle {
                        width: 100%;
                        height: 100%;
                    
                    // White background for intensity map
                    if root.show-intensity : Rectangle {
                        x: 0;
                        y: 0;
                        width: 100%;
                        height: 100%;
                        background: white;
                    }

                    // Grid layer
                    if root.show-grid && root.visualization-grid-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #808080;
                        stroke-width: 1px;
                        commands: root.visualization-grid-data;
                    }
                    
                    // Origin marker layer (yellow cross at 0,0)
                    if root.visualization-origin-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: yellow;
                        stroke-width: 2px;
                        commands: root.visualization-origin-data;
                    }
                    
                    // Rapid moves layer (G0) - Cyan, 50% opacity
                    if root.show-rapid-moves && root.visualization-rapid-moves-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #00FFFF80;  // Cyan with 50% opacity
                        stroke-width: 1px;
                        commands: root.visualization-rapid-moves-data;
                    }
                    
                    // G1 layer - Yellow
                    if root.show-cutting-moves && root.visualization-g1-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #FFFF00;
                        stroke-width: 1px;
                        commands: root.visualization-g1-data;
                    }

                    // G2 layer - Green
                    if root.show-cutting-moves && root.visualization-g2-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #00FF00;
                        stroke-width: 1px;
                        commands: root.visualization-g2-data;
                    }

                    // G3 layer - Bright Red
                    if root.show-cutting-moves && root.visualization-g3-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #FF0000;
                        stroke-width: 1px;
                        commands: root.visualization-g3-data;
                    }

                    // Intensity Layers (Black/Dark Red with varying opacity)
                    // Layer 0: 10% opacity
                    if root.show-intensity && root.visualization-intensity-layers[0] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.1;
                        commands: root.visualization-intensity-layers[0];
                    }
                    // Layer 1: 20% opacity
                    if root.show-intensity && root.visualization-intensity-layers[1] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.2;
                        commands: root.visualization-intensity-layers[1];
                    }
                    // Layer 2: 30% opacity
                    if root.show-intensity && root.visualization-intensity-layers[2] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.3;
                        commands: root.visualization-intensity-layers[2];
                    }
                    // Layer 3: 40% opacity
                    if root.show-intensity && root.visualization-intensity-layers[3] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.4;
                        commands: root.visualization-intensity-layers[3];
                    }
                    // Layer 4: 50% opacity
                    if root.show-intensity && root.visualization-intensity-layers[4] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.5;
                        commands: root.visualization-intensity-layers[4];
                    }
                    // Layer 5: 60% opacity
                    if root.show-intensity && root.visualization-intensity-layers[5] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.6;
                        commands: root.visualization-intensity-layers[5];
                    }
                    // Layer 6: 70% opacity
                    if root.show-intensity && root.visualization-intensity-layers[6] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.7;
                        commands: root.visualization-intensity-layers[6];
                    }
                    // Layer 7: 80% opacity
                    if root.show-intensity && root.visualization-intensity-layers[7] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.8;
                        commands: root.visualization-intensity-layers[7];
                    }
                    // Layer 8: 90% opacity
                    if root.show-intensity && root.visualization-intensity-layers[8] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 0.9;
                        commands: root.visualization-intensity-layers[8];
                    }
                    // Layer 9: 100% opacity
                    if root.show-intensity && root.visualization-intensity-layers[9] != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #000000;
                        stroke-width: root.raster-stroke-width;
                        opacity: 1.0;
                        commands: root.visualization-intensity-layers[9];
                    }

                    // G4 layer - Bright Blue
                    if root.visualization-g4-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #0000FF;
                        stroke-width: 1px;
                        commands: root.visualization-g4-data;
                    }

                    // Spindle/Laser Position Indicator
                    if root.show-spindle : Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: red;
                        border-width: 1px;
                        border-color: white;
                        // Calculate position based on viewbox
                        // Map machine coordinates (Y-up) to screen coordinates (Y-down)
                        // viewbox-y corresponds to -top (max Y in world space)
                        // screen_y = (top - machine_y) / height * screen_height
                        x: (root.machine-x-float - root.viewbox-x) / root.viewbox-width * parent.width - self.width/2;
                        y: (-root.viewbox-y - root.machine-y-float) / root.viewbox-height * parent.height - self.height/2;
                        
                        // Crosshair - Horizontal
                        Rectangle {
                            width: 24px;
                            height: 2px;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            background: red;
                        }
                        
                        // Crosshair - Vertical
                        Rectangle {
                            width: 2px;
                            height: 24px;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            background: red;
                        }
                    }
                    
                    // Mouse drag support for panning
                    TouchArea {
                        width: 100%;
                        height: 100%;
                        mouse-cursor: self.pressed ? grabbing : grab;
                        
                        property <length> drag-start-x;
                        property <length> drag-start-y;
                        
                        moved => {
                            if (self.pressed) {
                                root.pan-by-mouse(
                                    (self.mouse-x - self.drag-start-x) / 1px,
                                    (self.mouse-y - self.drag-start-y) / 1px
                                );
                                self.drag-start-x = self.mouse-x;
                                self.drag-start-y = self.mouse-y;
                            }
                        }
                        
                        pointer-event(event) => {
                            if (event.kind == PointerEventKind.down) {
                                self.drag-start-x = self.mouse-x;
                                self.drag-start-y = self.mouse-y;
                            }
                        }
                        
                        scroll-event(event) => {
                            if (event.delta-y > 0) {
                                root.zoom-in(root.canvas-width, root.canvas-height);
                            } else {
                                root.zoom-out(root.canvas-width, root.canvas-height);
                            }
                            accept
                        }
                    }
                }

                // Floating Status Bar (Bottom Left)
                Rectangle {
                    x: 10px;
                    y: parent.height - 40px;
                    height: 30px;
                    width: status-layout.preferred-width + 20px;
                    background: Theme.sidebar-background;
                    border-radius: 15px;
                    opacity: 0.9;
                    border-width: 1px;
                    border-color: Theme.sidebar-item-selected;
                    
                    status-layout := HorizontalLayout {
                        padding-left: 10px;
                        padding-right: 10px;
                        spacing: 15px;
                        
                        Text {
                            text: Math.round(root.zoom-scale * 100.0) + "%";
                            color: Theme.text-primary;
                            font-size: 12px;
                            font-weight: 700;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "X: " + Math.round(root.x-offset * 10.0) / 10.0;
                            color: Theme.text-secondary;
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "Y: " + Math.round(root.y-offset * 10.0) / 10.0;
                            color: Theme.text-secondary;
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                        
                        if root.show-grid : Text {
                            text: root.grid_size;
                            color: Theme.text-secondary;
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                    }
                }
                
                // Floating Zoom Controls (Bottom Right)
                Rectangle {
                    x: parent.width - 100px;
                    y: parent.height - 40px;
                    height: 30px;
                    width: 90px;
                    background: Theme.sidebar-background;
                    border-radius: 15px;
                    opacity: 0.9;
                    border-width: 1px;
                    border-color: Theme.sidebar-item-selected;
                    
                    HorizontalLayout {
                        alignment: center;
                        spacing: 5px;
                        
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            background: transparent;
                            Text { text: "-"; color: Theme.text-primary; font-size: 16px; vertical-alignment: center; horizontal-alignment: center; }
                            zoom-out-touch := TouchArea { clicked => { root.zoom-out(root.canvas-width, root.canvas-height); } }
                            StandardTooltip { text: "Zoom Out"; show: zoom-out-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2; }
                        }
                        
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            background: transparent;
                            Text { text: "Fit"; color: Theme.text-primary; font-size: 11px; vertical-alignment: center; horizontal-alignment: center; }
                            fit-touch := TouchArea { clicked => { root.fit-to-view(root.canvas-width, root.canvas-height); } }
                            StandardTooltip { text: "Fit to View"; show: fit-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2; }
                        }
                        
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            background: transparent;
                            Text { text: "+"; color: Theme.text-primary; font-size: 16px; vertical-alignment: center; horizontal-alignment: center; }
                            zoom-in-touch := TouchArea { width: 100%; height: 100%; clicked => { root.zoom-in(root.canvas-width, root.canvas-height); } }
                            StandardTooltip { text: "Zoom In"; show: zoom-in-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2; }
                        }
                    }
                }
                }
            }
        }
    }
}

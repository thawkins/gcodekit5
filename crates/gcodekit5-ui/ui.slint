//! GCodeKit4 Main UI
//! Universal G-Code Sender for CNC Machines
//! Modular UI with separated panel components

import "../../../assets/fonts/fira-code/FiraCode-Regular.ttf";

import { Button, ComboBox, LineEdit, TextEdit, VerticalBox, HorizontalBox, ScrollView, SpinBox, CheckBox, Palette } from "std-widgets.slint";

// Import all panel components
import { GcodeEditorPanel, TextLine } from "ui_panels/gcode_editor.slint";
export { TextLine }
import { DeviceConsolePanel } from "ui_panels/device_console.slint";
import { MachineControlPanel } from "ui_panels/machine_control.slint";
import { ConfigSettingsPanel, ConfigSetting } from "ui_panels/config_settings.slint";
import { DeviceInfoPanel, CapabilityItem } from "ui_panels/device_info.slint";
import { GcodeVisualizerPanel } from "../gcodekit5-visualizer/ui/legacy/gcode_visualizer.slint";
import { DesignerPanel } from "../gcodekit5-designer/ui/designer.slint";
import { CAMToolsPanel } from "ui_panels/cam_tools.slint";
import { MaterialsManager, MaterialData } from "ui_panels/materials_manager.slint";
import { ToolsManager, ToolData } from "ui_panels/tools_manager.slint";
import { SettingsDialog, SettingItem } from "../gcodekit5-settings/ui/settings_dialog.slint";
import { DeviceManagerPanel, DeviceProfileUiModel } from "../gcodekit5-devicedb/ui/device_manager.slint";
import { TabbedBoxDialog } from "../gcodekit5-camtools/ui/tabbed_box_dialog.slint";
import { SpoilboardSurfacingDialog } from "../gcodekit5-camtools/ui/spoilboard_surfacing_dialog.slint";
import { SpoilboardGridDialog } from "../gcodekit5-camtools/ui/spoilboard_grid_dialog.slint";
import { SpeedsFeedsDialog } from "../gcodekit5-camtools/ui/speeds_feeds_dialog.slint";
import { JigsawPuzzleDialog } from "../gcodekit5-camtools/ui/jigsaw_puzzle_dialog.slint";
import { LaserEngraverDialog } from "../gcodekit5-camtools/ui/laser_engraver_dialog.slint";
import { VectorEngraverDialog } from "../gcodekit5-camtools/ui/vector_engraver_dialog.slint";
import { ErrorDialog } from "ui_panels/error_dialog.slint";
import { SuccessDialog } from "ui_panels/success_dialog.slint";

export { 
    TabbedBoxDialog, SpoilboardSurfacingDialog, SpoilboardGridDialog, 
    SpeedsFeedsDialog, JigsawPuzzleDialog, LaserEngraverDialog, 
    VectorEngraverDialog, ErrorDialog, SuccessDialog
}

import { Theme } from "ui/theme.slint";

component TabItem inherits Rectangle {
    in property <string> text;
    in property <bool> selected;
    callback clicked;

    width: 130px;
    height: 40px;
    background: selected ? Theme.primary : transparent;

    Text {
        text: root.text;
        color: selected ? Theme.text-primary : Theme.text-secondary;
        font-size: 13px;
        font-weight: selected ? 700 : 400;
        vertical-alignment: center;
        horizontal-alignment: center;
    }
    
    // Bottom accent line
    Rectangle {
        width: 100%;
        height: 3px;
        y: parent.height - self.height;
        background: selected ? white : transparent;
    }

    TouchArea {
        clicked => { root.clicked(); }
    }
}

export struct PortInfo {
    port: string,
    description: string,
}

export struct DesignerShape {
    id: int,
    group_id: int,
    name: string,
    x: float,
    y: float,
    width: float,
    height: float,
    radius: float,
    corner_radius: float,
    is_slot: bool,
    x2: float,
    y2: float,
    shape_type: int,
    selected: bool,
    step_down: float,
    step_in: float,
    pocket_strategy: int,
    raster_angle: float,
    bidirectional: bool,
    use_custom_values: bool,
    rotation: float,
}

export struct DesignerState {
    mode: int,
    zoom: float,
    pan_x: float,
    pan_y: float,
    selected_id: int,
    update_counter: int,
    can_undo: bool,
    can_redo: bool,
    can_group: bool,
    can_ungroup: bool,
}

export component MainWindow inherits Window {
    title: "GCodeKit4 - GCode Toolkit for CNC/Laser Machines";
    background: Theme.background;
    preferred-width: 1280px;
    preferred-height: 800px;
    
    init => {
        Palette.color-scheme = ColorScheme.dark;
        about-dialog-visible = true;
        startup-timer.running = true;
    }
    
    property <duration> startup-delay: 6s;
    
    startup-timer := Timer {
        interval: root.startup-delay;
        running: false;
        triggered => {
            about-dialog-visible = false;
            self.running = false;
        }
    }
    
    // Busy cursor while processing
    in-out property <bool> is-busy: false;
    
    // Dynamic properties exposed to Rust
    in property <[string]> available-ports: [];
    in-out property <string> selected-port: "";
    in property <bool> connected: false;
    in property <string> connection-status: "Disconnected";
    in property <bool> show-menu-shortcuts: true;
    in-out property <float> progress-value: 0.0;
    in property <string> job-elapsed-time: "";
    in property <string> job-estimated-time: "";
    in property <string> device-version: "Unknown";
    in property <string> firmware-capabilities: "No firmware detected";
    in property <bool> cap-supports-arcs: false;
    in property <bool> cap-supports-probing: false;
    in property <bool> cap-supports-tool-change: false;
    in property <bool> cap-supports-variable-spindle: false;
    in property <bool> cap-supports-homing: false;
    in property <bool> cap-supports-overrides: false;
    in property <int> cap-max-axes: 3;
    in property <int> cap-coordinate-systems: 1;
    in property <[SettingItem]> current-settings: [];
    in property <float> position-x: 0.0;
    in property <float> position-y: 0.0;
    in property <float> position-z: 0.0;
    in property <float> work-position-x: 0.0;
    in property <float> work-position-y: 0.0;
    in property <float> work-position-z: 0.0;
    in property <float> position-a: 0.0;
    in property <float> position-b: 0.0;
    in property <float> position-c: 0.0;
    in property <float> feed-rate: 0.0;
    in property <float> spindle-speed: 0.0;
    in property <string> machine-state: "DISCONNECTED";
    in property <string> raw-status-response: "";
    in property <string> app-version: "0.9.1";
    in property <string> app-build-date: "2025-10-22";
    in property <string> app-description: "A Rust-based G-Code Sender for CNC and laser machines with support for GRBL and other controllers";
    in property <string> console-output: "[INFO] GCodeKit4 initialized\n[INFO] Ready for operation\n";
    in-out property <string> gcode-content: "";
    in-out property <string> current-view: "machine";
    in-out property <string> gcode-filename: "untitled.gcode";
    in property <int> console-scroll-trigger: 0;
    
    // Custom G-code Editor properties
    in-out property <bool> can-undo: false;
    in-out property <bool> can-redo: false;
    in-out property <int> cursor-line: 0;
    in-out property <int> cursor-column: 0;
    in-out property <[TextLine]> visible-lines: [];
    in-out property <int> total-lines: 0;
    in-out property <int> visible-start-line: 0;
    in property <bool> cursor-blink-visible: true;
    
    callback set-cursor-blink-visible(bool);
    
    // Configuration settings properties
    in property <[ConfigSetting]> config-settings: [];
    in property <[ConfigSetting]> config-filtered-settings: [];
    in-out property <string> config-filter-text: "";
    in-out property <string> config-selected-category: "All";
    in property <string> config-status-message: "";
    in property <bool> config-has-loaded-settings: false;
    
    // Config edit dialog properties
    in-out property <bool> show-edit-dialog: false;
    in-out property <int> edit-setting-number: 0;
    in-out property <string> edit-setting-name: "";
    in-out property <string> edit-setting-value: "";
    in-out property <string> edit-setting-unit: "";
    in-out property <string> edit-setting-description: "";
    
    // Device Info Panel Properties
    in property <string> device-firmware-type: "";
    in property <string> device-firmware-version: "";
    in property <string> device-name: "Unknown Device";
    in property <[CapabilityItem]> device-capabilities: [];
    
    // Visualizer panel properties
    in property <float> visualizer-progress: 0.0;
    in property <string> visualizer-status: "Ready";
    in property <float> visualizer-x-offset: 0.0;
    in property <float> visualizer-y-offset: 0.0;
    in property <float> visualizer-zoom-scale: 1.0;
    in property <string> visualizer-grid-size: "10mm";
    in property <string> visualizer-bounding-box-info: "";
    in-out property <bool> visualizer-show-grid: true;
    in-out property <bool> visualizer-show-rapid-moves: true;
    in-out property <bool> visualizer-show-cutting-moves: true;
    in-out property <bool> visualizer-show-intensity: false;
    in-out property <float> visualizer-max-intensity: 1000.0;
    in property <float> visualizer-viewbox-x: 0;
    in property <float> visualizer-viewbox-y: 0;
    in property <float> visualizer-viewbox-width: 100;
    in property <float> visualizer-viewbox-height: 100;
    in-out property <int> gcode-focus-trigger: 0;  // Incrementing this triggers editor focus
    in-out property <float> visualizer-canvas-width: 800.0;
    in-out property <float> visualizer-canvas-height: 600.0;
    in-out property <string> visualization-path-data: "";
    in-out property <string> visualization-g1-data: "";
    in-out property <string> visualization-g2-data: "";
    in-out property <string> visualization-g3-data: "";
    in-out property <string> visualization-g4-data: "";
    in-out property <string> visualization-rapid-moves-data: "";
    in-out property <string> visualization-grid-data: "";
    in-out property <string> visualization-origin-data: "";
    in-out property <[string]> visualization-intensity-layers: ["", "", "", "", "", "", "", "", "", ""];
    
    // Designer panel properties (Phase 2)
    in-out property <float> designer-canvas-width: 800.0;
    in-out property <float> designer-canvas-height: 600.0;
    in property <[DesignerShape]> designer-shapes: [];
    in property <DesignerState> designer-state: {
        mode: 0,
        zoom: 1.0,
        pan_x: 0.0,
        pan_y: 0.0,
        selected_id: -1,
    };
    in-out property <string> designer-feed-rate: "120.0";
    in-out property <string> designer-spindle-speed: "3000.0";
    in-out property <string> designer-tool-diameter: "3.175";
    in-out property <string> designer-cut-depth: "-5.0";
    in property <float> designer-safe-z: 10.0;
    in property <string> designer-generated-gcode: "";
    in property <bool> designer-gcode-generated: false;
    in property <string> designer-canvas-crosshair-data: "";
    in property <string> designer-canvas-grid-data: "";
    in property <string> designer-canvas-origin-data: "";
    in-out property <bool> designer-show-grid: true;
    in property <string> designer-grid-size: "10mm";
    in property <string> designer-canvas-shapes-data: "";
    in property <string> designer-canvas-grouped-shapes-data: "";
    in property <string> designer-canvas-group-bounding-box-data: "";
    in property <string> designer-canvas-selected-shapes-data: "";
    in property <string> designer-canvas-handles-data: "";
    in property <int> designer-selected-count: 0;
    in property <string> designer-selected-shape-x: "0.0";
    in property <string> designer-selected-shape-y: "0.0";
    in property <string> designer-selected-shape-w: "0.0";
    in property <string> designer-selected-shape-h: "0.0";
    in property <int> designer-selected-shape-type: 0;
    in property <string> designer-selected-shape-radius: "5.0";
    in property <bool> designer-selected-shape-is-pocket: false;
    in property <string> designer-selected-shape-pocket-depth: "0.0";
    in property <string> designer-selected-shape-step-down: "0.0";
    in property <string> designer-selected-shape-step-in: "0.0";
    in property <int> designer-selected-shape-pocket-strategy: 1;
    in property <string> designer-selected-shape-raster-angle: "0.0";
    in property <bool> designer-selected-shape-bidirectional: true;
    in property <bool> designer-selected-shape-use-custom-values: false;
    in property <string> designer-selected-shape-text-content: "";
    in property <string> designer-selected-shape-font-size: "12.0";
    in property <string> designer-selected-shape-name: "";
    in property <string> designer-selected-shape-corner-radius: "0.0";
    in property <bool> designer-selected-shape-is-slot: false;
    in property <string> designer-selected-shape-rotation: "0.0";
    in-out property <bool> designer-is-editing-defaults: false;
    in property <string> designer-unit-label: "mm";
    
    // Materials Manager properties
    in-out property <[MaterialData]> materials: [];
    
    // CNC Tools Manager properties
    in-out property <[ToolData]> cnc_tools: [];
    
    // Device Manager properties
    in-out property <[DeviceProfileUiModel]> device-profiles: [];
    in-out property <DeviceProfileUiModel> active-device-profile;
    in-out property <int> selected-device-index: -1;
    
    // Tabbed Box Maker properties (boxes.py algorithm)
    in-out property <string> tbox-x: "100.0";
    in-out property <string> tbox-y: "100.0";
    in-out property <string> tbox-h: "100.0";
    in-out property <string> tbox-thickness: "3.0";
    in-out property <string> tbox-burn: "0.1";
    in-out property <string> tbox-finger-width: "2.0";
    in-out property <string> tbox-space-width: "2.0";
    in-out property <string> tbox-surrounding-spaces: "2.0";
    in-out property <string> tbox-play: "0.0";
    in-out property <int> tbox-finger-style: 0;
    in-out property <int> tbox-box-type: 0;
    in-out property <bool> tbox-outside-dims: false;
    in-out property <string> tbox-laser-passes: "3";
    in-out property <string> tbox-laser-power: "1000";
    in-out property <string> tbox-feed-rate: "500";
    in-out property <string> tbox-offset-x: "10.0";
    in-out property <string> tbox-offset-y: "10.0";
    in-out property <string> tbox-extra-length: "0.0";
    in-out property <string> tbox-dimple-height: "0.0";
    in-out property <string> tbox-dimple-length: "0.0";
    in-out property <string> tbox-dividers-x: "0";
    in-out property <string> tbox-dividers-y: "0";
    in-out property <bool> tbox-optimize-layout: false;
    in-out property <int> tbox-key-divider-type: 0;
    
    // Jigsaw Puzzle properties
    in-out property <string> puzzle-width: "200.0";
    in-out property <string> puzzle-height: "150.0";
    in-out property <string> puzzle-pieces-across: "4";
    in-out property <string> puzzle-pieces-down: "3";
    in-out property <string> puzzle-kerf: "0.5";
    in-out property <string> puzzle-laser-passes: "3";
    in-out property <string> puzzle-laser-power: "1000";
    in-out property <string> puzzle-feed-rate: "500";
    in-out property <string> puzzle-seed: "42";
    in-out property <string> puzzle-tab-size: "20.0";
    in-out property <string> puzzle-jitter: "4.0";
    in-out property <string> puzzle-corner-radius: "2.0";
    in-out property <string> puzzle-offset-x: "10.0";
    in-out property <string> puzzle-offset-y: "10.0";
    
    // Speeds and Feeds Dialog properties
    in-out property <bool> speeds-feeds-dialog-visible: false;
    in property <[string]> sf-materials: [];
    in property <[string]> sf-tools: [];
    in property <[string]> sf-devices: [];
    in-out property <int> sf-selected-material-index: -1;
    in-out property <int> sf-selected-tool-index: -1;
    in-out property <int> sf-selected-device-index: -1;
    in property <string> sf-result-rpm: "---";
    in property <string> sf-result-unclamped-rpm: "";
    in property <string> sf-result-feed: "---";
    in property <string> sf-result-unclamped-feed: "";
    in property <string> sf-result-surface-speed: "---";
    in property <string> sf-result-chip-load: "---";
    in property <string> sf-result-source: "";
    in property <string> sf-result-warnings: "";
    in property <string> sf-unit-label: "mm";
    
    callback refresh-ports();
    callback connect(string, int);
    callback disconnect();
    callback menu-file-new();
    callback menu-file-open();
    callback menu-file-save();
    callback menu-file-save-as();
    callback menu-send-to-device();
    callback menu-stop-transmission();
    callback menu-pause-transmission();
    callback menu-resume-transmission();
    callback menu-file-exit();
    callback undo-requested();
    callback redo-requested();
    callback text-changed(string);
    callback scroll-changed(int);
    callback machine-jog-home();
    callback machine-jog-x-positive(float);
    callback machine-jog-x-negative(float);
    callback machine-jog-y-positive(float);
    callback machine-jog-y-negative(float);
    callback machine-jog-z-positive(float);
    callback machine-jog-z-negative(float);
    callback machine-jog-a-positive(float);
    callback machine-jog-a-negative(float);
    callback machine-jog-b-positive(float);
    callback machine-jog-b-negative(float);
    callback machine-unlock();
    callback machine-zero-all();
    callback machine-emergency-stop();
    callback menu-edit-preferences();
    callback menu-settings-save();
    callback menu-settings-cancel();
    callback menu-settings-restore-defaults();
    callback settings-category-selected(string);
    callback menu-view-fullscreen();
    callback menu-view-gcode-editor();
    callback menu-view-machine();
    callback menu-view-device-console();
    callback menu-view-gcode-visualizer();
    callback menu-view-designer();
    callback menu-view-materials();
    callback menu-view-cnc-tools();
    callback menu-help-about();
    callback key-pressed-event(string);  // Debug callback for keyboard events
    callback editor-clicked();  // Debug callback for editor clicks
    
    callback device-info-copy-config();
    
    // Materials Manager callbacks
    callback load_materials();
    callback create_material(MaterialData);
    callback update_material(MaterialData);
    callback delete_material(string);
    callback select_material(string);
    callback search_materials(string);
    callback filter_by_category(string);
    
    // CNC Tools Manager callbacks
    callback load_tools();
    callback create_tool(ToolData);
    callback update_tool(ToolData);
    callback delete_tool(string);
    callback select_tool(string);
    callback search_tools(string);
    callback filter_by_tool_type(string);
    callback import_gtc_package(string);
    
    // Device Manager callbacks
    callback load-device-profiles();
    callback add-device-profile();
    callback save-device-profile(DeviceProfileUiModel);
    callback delete-device-profile(string);
    callback set-active-device-profile(string);
    
    // Configuration settings callbacks
    callback config-retrieve-settings();
    callback config-save-to-file();
    callback config-load-from-file();
    callback config-restore-to-device();
    callback config-edit-setting(int);
    callback config-save-edited-setting(int, string);
    callback config-filter-changed();
    callback update-setting(string, string);
    callback browse-path(string);
    callback console-clear-clicked();
    callback console-copy-clicked();
    callback send-command(string);
    callback refresh-visualization(/* canvas_width */ float, /* canvas_height */ float, /* max_intensity */ float);
    callback zoom-in(/* canvas_width */ float, /* canvas_height */ float);
    callback zoom-out(/* canvas_width */ float, /* canvas_height */ float);
    callback reset-view(/* canvas_width */ float, /* canvas_height */ float);
    callback fit-to-view(/* canvas_width */ float, /* canvas_height */ float);
    callback toggle-grid();
    callback pan-by-mouse(/* dx */ float, /* dy */ float);
    
    // Designer callbacks (Phase 2)
    callback designer-set-mode(int);
    callback designer-zoom-in();
    callback designer-zoom-out();
    callback designer-zoom-fit();
    callback designer-reset-view();
    callback designer-delete-selected();
    callback designer-group-selected();
    callback designer-ungroup-selected();
    callback designer-clear-canvas();
    callback designer-generate-toolpath();
    callback designer-import-dxf();
    callback designer-import-svg();
    callback designer-add-dxf();
    callback designer-add-svg();
    callback designer-export-design();
    callback designer-canvas-click(float, float);
    callback designer-detect-handle(float, float) -> int;  // x, y - returns handle index
    callback designer-shape-drag(int, float, float);        // shape_id, dx, dy
    callback designer-handle-drag(int, int, float, float);  // shape_id, handle_index, dx, dy
    callback designer-canvas-pan(float, float);             // dx, dy - pan the viewport
    callback designer-deselect-all();
    callback designer-select-all();
    callback designer-select-in-rect(float, float, float, float, bool);
    callback designer-select-shape(int, bool);
    callback designer-set-shift-pressed(bool);              // Shift key state
    callback designer-save-shape-properties();              // Save all properties
    callback designer-update-shape-property(int, string);    // property_id, value
    callback designer-update-shape-property-bool(int, bool); // property_id, value
    callback designer-update-shape-property-string(int, string); // property_id, value
    callback designer-select-next-shape();
    callback designer-select-previous-shape();
    callback designer-align-horizontal-left();
    callback designer-align-horizontal-center();
    callback designer-align-horizontal-right();
    callback designer-align-vertical-top();
    callback designer-align-vertical-center();
    callback designer-align-vertical-bottom();
    callback designer-copy-selected();
    callback designer-paste-at-location(float, float);
    callback designer-undo();
    callback designer-redo();
    callback designer-interaction-start();
    callback designer-update-feed-rate(string);
    callback designer-update-spindle-speed(string);
    callback designer-update-tool-diameter(string);
    callback designer-update-cut-depth(string);
    callback designer-update-step-in(string);
    callback designer-file-new();
    callback designer-file-open();
    callback designer-file-save();
    callback designer-file-save-as();
    callback designer-toggle-grid();
    callback designer-edit-default-properties();
    callback invoke-designer-gcode-generated(string);
    callback show-delete-confirmation(int);
    callback designer-confirm-delete();
    callback designer-confirm-convert(string);
    callback designer-create-linear-array(int, int, string, string);
    callback designer-create-circular-array(int, string, string, string, string, bool);
    callback designer-create-grid-array(int, int, string, string);
    
     // CAM Tool callbacks
    callback generate-tabbed-box();
    callback generate-jigsaw-puzzle();
    callback generate-spoilboard-surfacing();
    callback generate-spoilboard-grid();
    callback generate-laser-engraving();
    callback generate-vector-engraving();
    callback calculate-speeds-feeds();
    callback load-speeds-feeds-data();
    
    // Custom editor callbacks
    callback clear_editor();
    callback append_gcode_line(string);
    callback load_editor_text(string);
    callback text_inserted(int, int, string);  // line, column, text
    callback text_deleted(int, int, int, int);  // start_line, start_col, end_line, end_col
    callback cursor_moved(int, int);  // line, column
    callback end_key_pressed();  // End key pressed
    callback ctrl_home_pressed();  // Ctrl+Home pressed
    callback ctrl_end_pressed();  // Ctrl+End pressed
    callback mouse_clicked(int, int);  // x, y in pixels
    callback find_requested(string);  // search text
    callback replace_requested(string, string);  // search, replace
    
    // Internal state for UI selections
    private property <int> port-index: 0;
    private property <int> console-scroll-ref: 0;
    private property <float> step-size: 1.0;
    private property <int> step-index: 1;
    private property <int> designer-delete-trigger: 0;
    private property <int> designer-delete-count: 0;
    
    // Private properties for dialogs
    private property <bool> about-dialog-visible: false;
    private property <bool> settings-dialog-visible: false;
    in-out property <string> settings-category: "controller";
    
    show-delete-confirmation(count) => {
        designer-delete-count = count;
        designer-delete-trigger += 1;
    }

    // Busy cursor overlay
    if root.is-busy : TouchArea {
        width: 100%;
        height: 100%;
        mouse-cursor: MouseCursor.wait;
    }
    
    // Root FocusScope to receive keyboard focus
    // Does NOT handle keys - just passes them through
    startup-focus := FocusScope {
        init => {
            startup-focus.focus();
        }
        
        key-pressed(event) => {
            return reject;  // Forward all keys to children
        }
    
    // Main content area - no FocusScope wrapper, let child elements handle focus
    VerticalBox {
        spacing: 0px;
        padding: 0px;
        
        // Main content area
        HorizontalBox {
            spacing: 0px;
            padding: 0px;
            
            // Main content area - File and Viewer
            VerticalBox {
                spacing: 0px;
                padding: 0px;
                horizontal-stretch: 1.0;
                vertical-stretch: 1.0;
                
                // Tab bar
                Rectangle {
                    background: Theme.sidebar-background;
                    height: 40px;
                    
                    HorizontalBox {
                        padding: 0px;
                        spacing: 0px;
                        alignment: start;
                        
                        TabItem {
                            text: "Machine Control";
                            selected: current-view == "machine";
                            clicked => {
                                current-view = "machine";
                                root.menu-view-machine();
                            }
                        }
                        
                        TabItem {
                            text: "Device Console";
                            selected: current-view == "device-console";
                            clicked => {
                                current-view = "device-console";
                                root.menu-view-device-console();
                            }
                        }
                        
                        TabItem {
                            text: "G-Code Editor";
                            selected: current-view == "gcode-editor";
                            clicked => {
                                current-view = "gcode-editor";
                                root.gcode-focus-trigger += 1;
                                root.menu-view-gcode-editor();
                            }
                        }
                        
                        TabItem {
                            text: "Visualizer";
                            selected: current-view == "gcode-visualizer";
                            width: 100px;
                            clicked => {
                                current-view = "gcode-visualizer";
                                root.menu-view-gcode-visualizer();
                            }
                        }

                        TabItem {
                            text: "ðŸ”§ CAM Tools";
                            selected: current-view == "cam-tools";
                            width: 120px;
                            clicked => {
                                current-view = "cam-tools";
                            }
                        }

                        TabItem {
                            text: "Designer";
                            selected: current-view == "designer";
                            width: 100px;
                            clicked => {
                                current-view = "designer";
                                root.menu-view-designer();
                            }
                        }
                        
                        TabItem {
                            text: "ðŸ“± Device Info";
                            selected: current-view == "device-info";
                            width: 110px;
                            clicked => {
                                current-view = "device-info";
                            }
                        }

                        TabItem {
                            text: "âš™ï¸ Device Config";
                            selected: current-view == "config-settings";
                            width: 130px;
                            clicked => {
                                current-view = "config-settings";
                            }
                        }
                        
                        TabItem {
                            text: "ðŸ–¥ï¸ Device Manager";
                            selected: current-view == "device-manager";
                            width: 140px;
                            clicked => {
                                current-view = "device-manager";
                                root.load-device-profiles();
                            }
                        }
                        
                        TabItem {
                            text: "ðŸ”© CNC Tools";
                            selected: current-view == "cnc-tools";
                            width: 110px;
                            clicked => {
                                current-view = "cnc-tools";
                                root.load_tools();
                            }
                        }
                        
                        TabItem {
                            text: "ðŸ“¦ Materials";
                            selected: current-view == "materials";
                            width: 110px;
                            clicked => {
                                current-view = "materials";
                                root.menu-view-materials();
                            }
                        }
                    }
                }
                
                // GCode Editor View - using imported component
                if current-view == "gcode-editor" : Rectangle {
                    background: transparent;
                    vertical-stretch: 1;
                    horizontal-stretch: 1;
                    
                    init => {
                        focus-timer.restart();
                    }
                    
                    editor-focus-wrapper := FocusScope {
                        vertical-stretch: 1;
                        horizontal-stretch: 1;
                        
                        // Use a timer to ensure focus is set after layout completes
                        focus-timer := Timer {
                            interval: 50ms;
                            triggered => {
                                gcode-editor-panel.focus();
                                focus-timer.stop();
                            }
                        }
                        
                        // Debug TouchArea for main view
                        main-editor-touch := TouchArea {
                            clicked => {
                            }
                        }
                        
                        gcode-editor-panel := GcodeEditorPanel {
                    gcode-content <=> root.gcode-content;
                    gcode-filename <=> root.gcode-filename;
                    focus-trigger <=> root.gcode-focus-trigger;
                    can-undo <=> root.can-undo;
                    can-redo <=> root.can-redo;
                    cursor-line <=> root.cursor-line;
                    cursor-column <=> root.cursor-column;
                    visible-lines <=> root.visible-lines;
                    total-lines <=> root.total-lines;
                    visible-start-line <=> root.visible-start-line;
                    cursor-blink-visible: root.cursor-blink-visible;
                    undo-requested => {
                        root.undo_requested();
                    }
                    redo-requested => {
                        root.redo_requested();
                    }
                    text-changed(text) => {
                        root.text-changed(text);
                    }
                    scroll-changed(line) => {
                        root.scroll_changed(line);
                    }
                    
                    end_key_pressed() => {
                        root.end_key_pressed();
                    }
                    
                    ctrl_home_pressed() => {
                        root.ctrl_home_pressed();
                    }
                    
                    ctrl_end_pressed() => {
                        root.ctrl_end_pressed();
                    }
                    
                    cursor_moved(line, col) => {
                        root.cursor_moved(line, col);
                    }
                    
                    request-focus => {
                        // Called when editor tab becomes active - handled from Rust
                    }
                    
                    text-inserted(line, col, text) => {
                        root.text_inserted(line, col, text);
                    }
                    
                    text-deleted(start-line, start-col, end-line, end-col) => {
                        root.text_deleted(start-line, start-col, end-line, end-col);
                    }
                    
                    key-pressed-event(msg) => {
                        root.key_pressed_event(msg);
                    }
                    
                    editor_clicked => {
                    }
                        }
                    }
                }
                
                // Device Console View
                // Device Console View - using imported component
                if current-view == "device-console" : DeviceConsolePanel {
                    console-output: root.console-output;
                    connected: root.connected;
                    console-clear-clicked => {
                        root.console-clear-clicked();
                    }
                    console-copy-clicked => {
                        root.console-copy-clicked();
                    }
                    send-command(cmd) => {
                        root.send-command(cmd);
                    }
                }
                
                // Machine Control View
                if current-view == "machine" : MachineControlPanel {
                    connected: root.connected;
                    available-ports: root.available-ports;
                    selected-port: root.selected-port;
                    position-x: root.position-x;
                    position-y: root.position-y;
                    position-z: root.position-z;
                    work-position-x: root.work-position-x;
                    work-position-y: root.work-position-y;
                    work-position-z: root.work-position-z;
                    position-a: root.position-a;
                    position-b: root.position-b;
                    position-c: root.position-c;
                    feed-rate: root.feed-rate;
                    spindle-speed: root.spindle-speed;
                    machine-state: root.machine-state;
                    raw-status-response: root.raw-status-response;
                    port-selected(port) => {
                        root.selected-port = port;
                    }
                    connect-clicked => {
                        root.connect(root.selected-port, 115200);
                    }
                    disconnect-clicked => {
                        root.disconnect();
                    }
                    refresh-ports-clicked => {
                        root.refresh-ports();
                    }
                    jog-home-clicked => {
                        root.machine-jog-home();
                    }
                    jog-x-positive(step) => {
                        root.machine-jog-x-positive(step);
                    }
                    jog-x-negative(step) => {
                        root.machine-jog-x-negative(step);
                    }
                    jog-y-positive(step) => {
                        root.machine-jog-y-positive(step);
                    }
                    jog-y-negative(step) => {
                        root.machine-jog-y-negative(step);
                    }
                    jog-z-positive(step) => {
                        root.machine-jog-z-positive(step);
                    }
                    jog-z-negative(step) => {
                        root.machine-jog-z-negative(step);
                    }
                    jog-a-positive(step) => {
                        root.machine-jog-a-positive(step);
                    }
                    jog-a-negative(step) => {
                        root.machine-jog-a-negative(step);
                    }
                    jog-b-positive(step) => {
                        root.machine-jog-b-positive(step);
                    }
                    jog-b-negative(step) => {
                        root.machine-jog-b-negative(step);
                    }
                    unlock-clicked => {
                        root.machine-unlock();
                    }
                    zero-all-clicked => {
                        root.machine-zero-all();
                    }
                    emergency-stop-clicked => {
                        root.machine-emergency-stop();
                    }
                    send-command(cmd) => {
                        root.send-command(cmd);
                    }
                    command-send => {
                        root.menu-send-to-device();
                    }
                    command-pause => {
                        root.menu-pause-transmission();
                    }
                    command-resume => {
                        root.menu-resume-transmission();
                    }
                    command-stop => {
                        root.menu-stop-transmission();
                    }
                }
                
                // Device Info View
                if current-view == "device-info" : device-info := DeviceInfoPanel {
                    connected: root.connected;
                    firmware-type: root.device-firmware-type;
                    firmware-version: root.device-firmware-version;
                    device-name: root.device-name;
                    capabilities: root.device-capabilities;
                    copy-config-clicked => {
                        root.device-info-copy-config();
                    }
                }

                // Device Manager View
                if current-view == "device-manager" : DeviceManagerPanel {
                    profiles: root.device-profiles;
                    active-profile: root.active-device-profile;
                    selected-index <=> root.selected-device-index;
                    
                    add-profile => {
                        root.add-device-profile();
                    }

                    save-profile(profile) => {
                        root.save-device-profile(profile);
                    }
                    
                    delete-profile(id) => {
                        root.delete-device-profile(id);
                    }
                    
                    set-active-profile(id) => {
                        root.set-active-device-profile(id);
                    }
                }
                
                // Configuration Settings View
                if current-view == "config-settings" : config-panel := ConfigSettingsPanel {
                    connected: root.connected;
                    settings: root.config-settings;
                    filtered-settings: root.config-filtered-settings;
                    filter-text <=> root.config-filter-text;
                    selected-category <=> root.config-selected-category;
                    status-message: root.config-status-message;
                    has-loaded-settings: root.config-has-loaded-settings;
                    show-edit-dialog <=> root.show-edit-dialog;
                    edit-setting-number <=> root.edit-setting-number;
                    edit-setting-name <=> root.edit-setting-name;
                    edit-setting-value <=> root.edit-setting-value;
                    edit-setting-unit <=> root.edit-setting-unit;
                    edit-setting-description <=> root.edit-setting-description;
                    
                    retrieve-settings => {
                        root.config-retrieve-settings();
                    }
                    
                    save-to-file => {
                        root.config-save-to-file();
                    }
                    
                    load-from-file => {
                        root.config-load-from-file();
                    }
                    
                    restore-to-device => {
                        root.config-restore-to-device();
                    }
                    
                    edit-setting(number) => {
                        root.config-edit-setting(number);
                    }
                    
                    save-edited-setting(number, value) => {
                        root.config-save-edited-setting(number, value);
                    }
                    
                    filter-changed => {
                        root.config-filter-changed();
                    }
                }

                // GCode Visualizer View
                if current-view == "gcode-visualizer" : Rectangle {
                    vertical-stretch: 1;
                    horizontal-stretch: 1;
                    background: transparent;

                    visualizer-panel := GcodeVisualizerPanel {
                        width: 100%;
                        height: 100%;
                        gcode-filename <=> root.gcode-filename;
                        gcode-content <=> root.gcode-content;
                        visualization-path-data: root.visualization-path-data;
                        visualization-g1-data: root.visualization-g1-data;
                        visualization-g2-data: root.visualization-g2-data;
                        visualization-g3-data: root.visualization-g3-data;
                        visualization-g4-data: root.visualization-g4-data;
                        visualization-rapid-moves-data: root.visualization-rapid-moves-data;
                        visualization-grid-data: root.visualization-grid-data;
                        visualization-origin-data: root.visualization-origin-data;
                        machine-x-float: root.position-x;
                        machine-y-float: root.position-y;
                        machine-x: Math.round(root.position-x * 1000) / 1000 + "";
                        machine-y: Math.round(root.position-y * 1000) / 1000 + "";
                        machine-z: Math.round(root.position-z * 1000) / 1000 + "";
                        work-x: Math.round(root.position-a * 1000) / 1000 + "";
                        work-y: Math.round(root.position-b * 1000) / 1000 + "";
                        work-z: Math.round(root.position-c * 1000) / 1000 + "";
                        progress: root.visualizer-progress;
                        visualizer-status: root.visualizer-status;
                        x-offset: root.visualizer-x-offset;
                        y-offset: root.visualizer-y-offset;
                        zoom-scale: root.visualizer-zoom-scale;
                        grid-size: root.visualizer-grid-size;
                        bounding-box-info: root.visualizer-bounding-box-info;
                        show-grid <=> root.visualizer-show-grid;
                        show-rapid-moves <=> root.visualizer-show-rapid-moves;
                        show-cutting-moves <=> root.visualizer-show-cutting-moves;
                        show-intensity <=> root.visualizer-show-intensity;
                        max-intensity <=> root.visualizer-max-intensity;
                        visualization-intensity-layers: root.visualization-intensity-layers;
                        viewbox-x: root.visualizer-viewbox-x;
                        viewbox-y: root.visualizer-viewbox-y;
                        viewbox-width: root.visualizer-viewbox-width;
                        viewbox-height: root.visualizer-viewbox-height;
                        
                        refresh-visualization(canvas-width, canvas-height, max-intensity) => {
                            root.visualizer-canvas-width = canvas-width;
                            root.visualizer-canvas-height = canvas-height;
                            root.refresh-visualization(canvas-width, canvas-height, max-intensity);
                        }
                        
                        zoom-in(canvas-width, canvas-height) => {
                            root.visualizer-canvas-width = canvas-width;
                            root.visualizer-canvas-height = canvas-height;
                            root.zoom-in(canvas-width, canvas-height);
                        }
                        
                        zoom-out(canvas-width, canvas-height) => {
                            root.visualizer-canvas-width = canvas-width;
                            root.visualizer-canvas-height = canvas-height;
                            root.zoom-out(canvas-width, canvas-height);
                        }
                        
                        reset-view(canvas-width, canvas-height) => {
                            root.visualizer-canvas-width = canvas-width;
                            root.visualizer-canvas-height = canvas-height;
                            root.reset-view(canvas-width, canvas-height);
                        }
                        
                        fit-to-view(canvas-width, canvas-height) => {
                            root.visualizer-canvas-width = canvas-width;
                            root.visualizer-canvas-height = canvas-height;
                            root.fit-to-view(canvas-width, canvas-height);
                        }
                        
                        toggle-grid => {
                            root.toggle-grid();
                        }
                        
                        pan-by-mouse(dx, dy) => {
                            root.pan-by-mouse(dx, dy);
                        }
                    }

                    // Timer to sync canvas size to root properties
                    // This ensures Rust gets the correct size when calling get_visualizer_canvas_width()
                    Timer {
                        interval: 50ms;
                        running: true;
                        triggered => {
                            if (root.visualizer-canvas-width != visualizer-panel.canvas-width || root.visualizer-canvas-height != visualizer-panel.canvas-height) {
                                root.visualizer-canvas-width = visualizer-panel.canvas-width;
                                root.visualizer-canvas-height = visualizer-panel.canvas-height;
                            }
                        }
                    }
                }

                // Designer View
                if current-view == "designer" : Rectangle {
                    vertical-stretch: 1;
                    horizontal-stretch: 1;
                    background: transparent;

                    designer-panel := DesignerPanel {
                        width: 100%;
                        height: 100%;
                        shapes: root.designer-shapes;
                        designer_state: root.designer-state;
                        feed_rate <=> root.designer-feed-rate;
                        spindle_speed <=> root.designer-spindle-speed;
                        tool_diameter <=> root.designer-tool-diameter;
                        cut_depth <=> root.designer-cut-depth;
                        generated_gcode: root.designer-generated-gcode;
                        gcode_generated: root.designer-gcode-generated;
                        zoom_scale: root.designer-state.zoom;
                        x_offset: root.designer-state.pan_x;
                        y_offset: root.designer-state.pan_y;
                        canvas_crosshair_data: root.designer-canvas-crosshair-data;
                        canvas_grid_data: root.designer-canvas-grid-data;
                        canvas_origin_data: root.designer-canvas-origin-data;
                        show_grid <=> root.designer-show-grid;
                        grid_size: root.designer-grid-size;
                        canvas_shapes_data: root.designer-canvas-shapes-data;
                        canvas_grouped_shapes_data: root.designer-canvas-grouped-shapes-data;
                        canvas_group_bounding_box_data: root.designer-canvas-group-bounding-box-data;
                        canvas_selected_shapes_data: root.designer-canvas-selected-shapes-data;
                        canvas_handles_data: root.designer-canvas-handles-data;
                        delete_confirmation_trigger: root.designer-delete-trigger;
                        delete_confirmation_count: root.designer-delete-count;
                        selected_count: root.designer-selected-count;
                        selected_shape_x: root.designer-selected-shape-x;
                        selected_shape_y: root.designer-selected-shape-y;
                        selected_shape_w: root.designer-selected-shape-w;
                        selected_shape_h: root.designer-selected-shape-h;
                        selected_shape_type: root.designer-selected-shape-type;
                        selected_shape_radius: root.designer-selected-shape-radius;
                        selected_shape_is_pocket: root.designer-selected-shape-is_pocket;
                        selected_shape_pocket_depth: root.designer-selected-shape-pocket-depth;
                        selected_shape_step_down: root.designer-selected-shape-step-down;
                        selected_shape_step_in: root.designer-selected-shape-step-in;
                        selected_shape_pocket_strategy: root.designer-selected-shape-pocket-strategy;
                        selected_shape_raster_angle: root.designer-selected-shape-raster-angle;
                        selected_shape_bidirectional: root.designer-selected-shape-bidirectional;
                        selected_shape_use_custom_values: root.designer-selected-shape-use-custom-values;
                        selected_shape_text_content: root.designer-selected-shape-text-content;
                        selected_shape_font_size: root.designer-selected-shape-font-size;
                        selected_shape_name: root.designer-selected-shape-name;
                        selected_shape_corner_radius: root.designer-selected-shape-corner-radius;
                        selected_shape_is_slot: root.designer-selected-shape-is_slot;
                        selected_shape_rotation: root.designer-selected-shape-rotation;
                        is_editing_defaults <=> root.designer-is-editing-defaults;
                        unit-label: root.designer-unit-label;
                        
                        set_mode(m) => {
                            root.designer-set-mode(m);
                        }
                        
                        zoom_in => {
                            root.designer-zoom-in();
                        }
                        
                        zoom_out => {
                            root.designer-zoom-out();
                        }
                        
                        zoom_fit => {
                            root.designer-zoom-fit();
                        }
                        
                        reset_view => {
                            root.designer-reset-view();
                        }
                        
                        delete_selected => {
                            root.designer-delete-selected();
                        }
                        
                        group_selected => {
                            root.designer-group-selected();
                        }
                        
                        ungroup_selected => {
                            root.designer-ungroup-selected();
                        }
                        
                        clear_canvas => {
                            root.designer-clear-canvas();
                        }
                        
                        generate_toolpath => {
                            root.designer-generate-toolpath();
                        }
                        
                        import_dxf => {
                            root.designer-import-dxf();
                        }
                        
                        import_svg => {
                            root.designer-import-svg();
                        }
                        
                        export_design => {
                            root.designer-export-design();
                        }
                        
                        canvas_click(x, y) => {
                            root.designer-canvas-click(x, y);
                        }

                        select_in_rect(x, y, w, h, multi) => {
                            root.designer-select-in-rect(x, y, w, h, multi);
                        }

                        select_shape(id, multi) => {
                            root.designer-select-shape(id, multi);
                        }
                        
                        detect_handle(x, y) => {
                            return root.designer-detect-handle(x, y);
                        }
                        
                        shape_drag(id, dx, dy) => {
                            root.designer-shape-drag(id, dx, dy);
                        }
                        
                        handle_drag(id, handle, dx, dy) => {
                            root.designer-handle-drag(id, handle, dx, dy);
                        }
                        
                        canvas_pan(dx, dy) => {
                            root.designer-canvas-pan(dx, dy);
                        }
                        
                        deselect_all => {
                            root.designer-deselect-all();
                        }
                        
                        set_shift_pressed(pressed) => {
                            root.designer-set-shift-pressed(pressed);
                        }
                        
                        save_shape_properties() => {
                            root.designer-save-shape-properties();
                        }
                        
                        update_shape_property(prop_id, value) => {
                            root.designer-update-shape-property(prop_id, value);
                        }
                        update_shape_property_bool(prop_id, value) => {
                            root.designer-update-shape-property-bool(prop_id, value);
                        }
                        update_shape_property_string(prop_id, value) => {
                            root.designer-update-shape-property-string(prop_id, value);
                        }
                        
                        confirm_delete => {
                            root.designer-confirm-delete();
                        }
                        
                        confirm_convert(type) => {
                            root.designer-confirm-convert(type);
                        }
                        
                        create_linear_array(cx, cy, sx, sy) => {
                            root.designer-create-linear-array(cx, cy, sx, sy);
                        }
                        
                        create_circular_array(c, cx, cy, r, sa, cw) => {
                            root.designer-create-circular-array(c, cx, cy, r, sa, cw);
                        }
                        
                        create_grid_array(c, r, cs, rs) => {
                            root.designer-create-grid-array(c, r, cs, rs);
                        }
                        
                        align_horizontal_left => {
                            root.designer-align-horizontal-left();
                        }
                        align_horizontal_center => {
                            root.designer-align-horizontal-center();
                        }
                        align_horizontal_right => {
                            root.designer-align-horizontal-right();
                        }
                        align_vertical_top => {
                            root.designer-align-vertical-top();
                        }
                        align_vertical_center => {
                            root.designer-align-vertical-center();
                        }
                        align_vertical_bottom => {
                            root.designer-align-vertical-bottom();
                        }

                        copy_selected => {
                            root.designer-copy-selected();
                        }

                        paste_at_location(x, y) => {
                            root.designer-paste-at-location(x, y);
                        }

                        undo => {
                            root.designer-undo();
                        }

                        redo => {
                            root.designer-redo();
                        }

                        designer-interaction-start => {
                            root.designer-interaction-start();
                        }
                        
                        edit_default_properties => {
                            root.designer-edit-default-properties();
                        }
                        
                        update_feed_rate(rate) => {
                            root.designer-update-feed-rate(rate);
                        }
                        
                        update_spindle_speed(speed) => {
                            root.designer-update-spindle-speed(speed);
                        }
                        
                        update_tool_diameter(diameter) => {
                            root.designer-update-tool-diameter(diameter);
                        }
                        
                        update_cut_depth(depth) => {
                            root.designer-update-cut-depth(depth);
                        }
                        
                        update_step_in(val) => {
                            root.designer-update-step-in(val);
                        }
                        
                        file_new => {
                            root.designer-file-new();
                        }
                        
                        file_open => {
                            root.designer-file-open();
                        }
                        
                        file_save => {
                            root.designer-file-save();
                        }
                        
                        file_save_as => {
                            root.designer-file-save-as();
                        }
                        
                        toggle_grid => {
                            root.designer-toggle-grid();
                        }
                        
                        select_next_shape => {
                            root.designer-select-next-shape();
                        }
                        
                        select_previous_shape => {
                            root.designer-select-previous-shape();
                        }
                    }

                    // Timer to sync canvas size to root properties
                    Timer {
                        interval: 50ms;
                        running: true;
                        triggered => {
                            if (root.designer-canvas-width != designer-panel.canvas-width || root.designer-canvas-height != designer-panel.canvas-height) {
                                root.designer-canvas-width = designer-panel.canvas-width;
                                root.designer-canvas-height = designer-panel.canvas-height;
                            }
                        }
                    }
                }
                
                // CAM Tools View
                if current-view == "cam-tools" : Rectangle {
                    CAMToolsPanel {
                        width: 100%;
                        height: 100%;
                        open-tabbed-box-maker => {
                            root.generate-tabbed-box();
                        }
                        open-jigsaw-puzzle-maker => {
                            root.generate-jigsaw-puzzle();
                        }
                        open-spoilboard-surfacing => {
                            root.generate-spoilboard-surfacing();
                        }
                        open-spoilboard-grid => {
                            root.generate-spoilboard-grid();
                        }
                        open-laser-engraver => {
                            root.generate-laser-engraving();
                        }
                        open-vector-engraver => {
                            root.generate-vector-engraving();
                        }
                        open-speeds-feeds-calculator => {
                            root.load-speeds-feeds-data();
                            root.speeds-feeds-dialog-visible = true;
                        }
                    }

                    // Speeds and Feeds Dialog
                    if speeds-feeds-dialog-visible : Rectangle {
                        x: 0;
                        y: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z: 2000;
                        
                        TouchArea {
                            clicked => { speeds-feeds-dialog-visible = false; }
                        }
                        
                        SpeedsFeedsDialog {
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            materials: root.sf-materials;
                            tools: root.sf-tools;
                            devices: root.sf-devices;
                            selected-material-index <=> root.sf-selected-material-index;
                            selected-tool-index <=> root.sf-selected-tool-index;
                            selected-device-index <=> root.sf-selected-device-index;
                            result-rpm: root.sf-result-rpm;
                            result-unclamped-rpm: root.sf-result-unclamped-rpm;
                            result-feed: root.sf-result-feed;
                            result-unclamped-feed: root.sf-result-unclamped-feed;
                            result-surface-speed: root.sf-result-surface-speed;
                            result-chip-load: root.sf-result-chip-load;
                            result-source: root.sf-result-source;
                            result-warnings: root.sf-result-warnings;
                            unit-label: root.sf-unit-label;
                            
                            calculate => { root.calculate-speeds-feeds(); }
                            close-dialog => { speeds-feeds-dialog-visible = false; }
                        }
                    }
                }
                
                // Materials View
                if current-view == "materials" : MaterialsManager {
                    materials <=> root.materials;
                    load_materials => {
                        root.load_materials();
                    }
                    create_material(data) => {
                        root.create_material(data);
                    }
                    update_material(data) => {
                        root.update_material(data);
                    }
                    delete_material(id) => {
                        root.delete_material(id);
                    }
                    select_material(id) => {
                        root.select_material(id);
                    }
                    search_materials(query) => {
                        root.search_materials(query);
                    }
                    filter_by_category(category) => {
                        root.filter_by_category(category);
                    }
                }
                
                // CNC Tools View
                if current-view == "cnc-tools" : ToolsManager {
                    tools <=> root.cnc_tools;
                    load_tools => {
                        root.load_tools();
                    }
                    create_tool(data) => {
                        root.create_tool(data);
                    }
                    update_tool(data) => {
                        root.update_tool(data);
                    }
                    delete_tool(id) => {
                        root.delete_tool(id);
                    }
                    select_tool(id) => {
                        root.select_tool(id);
                    }
                    search_tools(query) => {
                        root.search_tools(query);
                    }
                    filter_by_type(tool_type) => {
                        root.filter_by_tool_type(tool_type);
                    }
                    import_gtc_package(file_path) => {
                        root.import_gtc_package(file_path);
                    }
                }
            }
        }
        
        // Status Panel - Compact Single Line
        Rectangle {
            height: 30px;
            background: #2c3e50;
            
            // Left side status text
            HorizontalBox {
                padding-top: 5px;
                padding-bottom: 5px;
                padding-left: 10px;
                padding-right: 10px;
                spacing: 0px;
                alignment: start;
                
                // Emergency Stop Button
                Rectangle {
                    width: 50px;
                    height: 20px;
                    background: #e74c3c;
                    border-radius: 3px;
                    
                    Text {
                        text: "eStop";
                        color: white;
                        font-size: 11px;
                        font-weight: 700;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => { root.machine-emergency-stop(); }
                    }
                }
                
                // Separator
                Text {
                    text: " \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                }
                
                // Connection Status Indicator (colored square)
                Rectangle {
                    width: 16px;
                    height: 16px;
                    background: root.connected ? #2ecc71 : #e74c3c;
                    border-radius: 2px;
                }
                
                // Separator 1
                Text {
                    text: " \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                }
                
                // Port Display
                Text {
                    text: root.connected ? root.selected-port : "Disconnected";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
                
                // Separator between Port and Version
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }
                
                // Version Label and Device Info
                Text {
                    text: root.connected ? "Version: " + root.device-version : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
                
                // Separator 2 - Visual separator with EM spaces
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }

                // Machine State Display
                Text {
                    text: root.machine-state;
                    color: root.machine-state == "ALARM" ? #e74c3c : 
                           (root.machine-state == "Run" ? #2ecc71 : 
                           (root.machine-state == "Hold" || root.machine-state == "Hold:0" || root.machine-state == "Hold:1" ? #e67e22 : 
                           (root.machine-state == "Idle" || root.machine-state == "IDLE" ? #f1c40f : white)));
                    font-size: 13.2px;
                    font-weight: 700;
                    font-family: "Monospace";
                    visible: root.connected;
                }

                // Separator 3
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }
                
                // Position Label
                Text {
                    text: "Position:";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
                
                // Position Display (X, Y, Z, A, B, C) - shown only when connected
                Text {
                    text: root.connected ? "\u{2003}X: " + round(root.position-x * 1000.0) / 1000.0 + "  Y: " + round(root.position-y * 1000.0) / 1000.0 + "  Z: " + round(root.position-z * 1000.0) / 1000.0 + "  A: " + round(root.position-a * 1000.0) / 1000.0 + "  B: " + round(root.position-b * 1000.0) / 1000.0 + "  C: " + round(root.position-c * 1000.0) / 1000.0 : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
            }
            
            // Progress indicator - absolutely positioned on the right
            HorizontalBox {
                x: parent.width - self.width - 30px;
                y: -1px;
                width: 450px;
                spacing: 5px;
                alignment: end;
                
                Text {
                    text: "Elapsed:";
                    color: white;
                    font-size: 13.2px;
                    visible: root.progress-value > 0.0;
                }

                Text {
                    text: root.job-elapsed-time;
                    color: white;
                    font-size: 13.2px;
                    visible: root.progress-value > 0.0;
                }

                Text {
                    text: "  ";
                    visible: root.progress-value > 0.0;
                }

                Text {
                    text: "Remaining:";
                    color: white;
                    font-size: 13.2px;
                    visible: root.progress-value > 0.0 && root.job-estimated-time != "";
                }

                Text {
                    text: root.job-estimated-time;
                    color: white;
                    font-size: 13.2px;
                    visible: root.progress-value > 0.0;
                }

                Text {
                    text: "  ";
                    visible: root.progress-value > 0.0;
                }

                Text {
                    text: "Progress:";
                    color: white;
                    font-size: 13.2px;
                    visible: root.progress-value > 0.0;
                }
                
                Rectangle {
                    width: 100px;
                    height: 18px;
                    border-width: 1px;
                    border-color: white;
                    border-radius: 3px;
                    visible: root.progress-value > 0.0;
                    
                    Rectangle {
                        x: 0;
                        y: 0;
                        width: parent.width * root.progress-value / 100.0;
                        height: parent.height;
                        background: #3498db;
                        border-radius: 3px;
                    }
                    
                    Text {
                        text: round(root.progress-value) + "%";
                        color: white;
                        font-size: 11px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
    

    

    
    // About Dialog
    if about-dialog-visible : Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z: 2000;
        
        TouchArea {
            // Close dialog on background click
            clicked => {
                about-dialog-visible = false;
            }
        }
        
        Rectangle {
            x: (parent.width - 550px) / 2;
            y: (parent.height - 362px) / 2;
            width: 550px;
            height: 362px;
            background: #ecf0f1;
            border-radius: 5px;
            z: 2001;
            
            Image {
                source: @image-url("ui/images/gcodekit5.png");
                width: 100%;
                height: 100%;
                image-fit: cover;
            }
            
            VerticalBox {
                padding: 15px;
                spacing: 15px;
                alignment: end;
                padding-left: 300px;
                
                // Program Name - Triple Size
                Text {
                    text: "GCodeKit4";
                    font-size: 42px;
                    font-weight: 700;
                    color: yellow;
                    horizontal-alignment: right;
                }
                
                // Description
                Text {                   
                    text: root.app-description;
                    font-size: 11px;
                    color: lightgrey;
                    horizontal-alignment: right;
                    wrap: word-wrap;
                }
                
                // Version
                Text {
                    text: "Version: " + root.app-version;
                    font-size: 13px;
                    color: lightblue;
                    horizontal-alignment: right;
                }
                
                // Build Date
                Text {
                    text: "Built: " + root.app-build-date;
                    font-size: 13px;
                    color: lightgrey;
                    horizontal-alignment: right;
                }
                
                // Spacer
                Rectangle {
                    height: 30px;
                }
                
                // OK Button - Lower Right
                HorizontalBox {
                    alignment: end;
                    
                    Button {
                        text: "Ok";
                        width: 80px;
                        height: 35px;
                        clicked => {
                            about-dialog-visible = false;
                        }
                    }
                }
            }
        }
    }
    
    // Settings Dialog
    SettingsDialog {
        visible: settings-dialog-visible;
        dialog-visible <=> settings-dialog-visible;
        settings-category: settings-category;
        current-settings: current-settings;
        menu-settings-save => { root.menu-settings-save(); }
        menu-settings-cancel => { root.menu-settings-cancel(); }
        menu-settings-restore-defaults => { root.menu-settings-restore-defaults(); }
        update-setting(id, value) => { root.update-setting(id, value); }
        category-selected(category) => { root.settings-category-selected(category); }
        browse-path(id) => { root.browse-path(id); }
    }
    
    }  // Close root FocusScope (startup-focus)
    // Native menu bar with dark theme support
    MenuBar {
        Menu {
            title: @tr("File");
            MenuItem {
                title: root.current-view == "designer" ? "Design File" : "GCode File";
                enabled: false;
            }
            MenuItem {
                title: "----------------";
                enabled: false;
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "New                             Ctrl+N" : "New";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-file-new();
                    } else {
                        root.menu-file-new();
                    }
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Open File                        Ctrl+O" : "Open File";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-file-open();
                    } else {
                        root.menu-file-open();
                    }
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Save File                        Ctrl+S" : "Save File";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-file-save();
                    } else {
                        root.menu-file-save();
                    }
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Save As                     Ctrl+Shift+S" : "Save As";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-file-save-as();
                    } else {
                        root.menu-file-save-as();
                    }
                }
            }
            MenuItem {
                title: "----------------";
                enabled: false;
            }
            Menu {
                title: @tr("Export");
                enabled: root.current-view == "designer";
                MenuItem {
                    title: @tr("G-Code");
                    enabled: root.current-view == "designer" && root.designer-shapes.length > 0;
                    activated => {
                        root.designer-generate-toolpath();
                    }
                }
            }
            Menu {
                title: @tr("Load");
                enabled: root.current-view == "designer";
                MenuItem {
                    title: @tr("DXF");
                    activated => {
                        root.designer-import-dxf();
                    }
                }
                MenuItem {
                    title: @tr("SVG");
                    activated => {
                        root.designer-import-svg();
                    }
                }
            }
            Menu {
                title: @tr("Add");
                enabled: root.current-view == "designer";
                MenuItem {
                    title: @tr("DXF");
                    activated => {
                        root.designer-add-dxf();
                    }
                }
                MenuItem {
                    title: @tr("SVG");
                    activated => {
                        root.designer-add-svg();
                    }
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Exit                            Ctrl+Q" : "Exit";
                activated => { root.menu-file-exit(); }
            }
        }
        
        Menu {
            title: @tr("Edit");
            MenuItem {
                title: root.show-menu-shortcuts ? "Select All                      Ctrl+A" : "Select All";
                enabled: root.current-view == "designer" && root.designer-shapes.length > 0;
                activated => {
                    root.designer-select-all();
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Undo                             Ctrl+Z" : "Undo";
                enabled: root.current-view == "designer" ? root.designer-state.can_undo : root.can-undo;
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-undo();
                    } else {
                        root.undo-requested();
                    }
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Redo                        Ctrl+Shift+Z" : "Redo";
                enabled: root.current-view == "designer" ? root.designer-state.can_redo : root.can-redo;
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-redo();
                    } else {
                        root.redo-requested();
                    }
                }
            }
            MenuItem {
                title: "----------------";
                enabled: false;
            }
            MenuItem {
                title: @tr("Preferences");
                activated => { 
                    root.menu-edit-preferences();
                    settings-dialog-visible = true;
                }
            }
        }
        
        Menu {
            title: @tr("View");
            MenuItem {
                title: root.show-menu-shortcuts ? "Zoom In                              +" : "Zoom In";
                enabled: root.current-view == "designer" || root.current-view == "gcode-visualizer";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-zoom-in();
                    } else if (root.current-view == "gcode-visualizer") {
                        root.zoom-in(root.visualizer-canvas-width, root.visualizer-canvas-height);
                    }
                }
            }
            MenuItem {
                title: root.show-menu-shortcuts ? "Zoom Out                             -" : "Zoom Out";
                enabled: root.current-view == "designer" || root.current-view == "gcode-visualizer";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-zoom-out();
                    } else if (root.current-view == "gcode-visualizer") {
                        root.zoom-out(root.visualizer-canvas-width, root.visualizer-canvas-height);
                    }
                }
            }
            MenuItem {
                title: @tr("Fit to View");
                enabled: root.current-view == "designer" || root.current-view == "gcode-visualizer";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-zoom-fit();
                    } else if (root.current-view == "gcode-visualizer") {
                        root.fit-to-view(root.visualizer-canvas-width, root.visualizer-canvas-height);
                    }
                }
            }
            MenuItem {
                title: @tr("Reset to Default");
                enabled: root.current-view == "designer" || root.current-view == "gcode-visualizer";
                activated => {
                    if (root.current-view == "designer") {
                        root.designer-reset-view();
                    } else if (root.current-view == "gcode-visualizer") {
                        root.reset-view(root.visualizer-canvas-width, root.visualizer-canvas-height);
                    }
                }
            }
            MenuItem {
                title: "----------------";
                enabled: false;
            }
            MenuItem {
                title: current-view == "machine" ? @tr("âœ“ Machine Control") : @tr("Machine Control");
                activated => {
                    if (current-view != "machine") {
                        current-view = "machine";
                        root.menu-view-machine();
                    }
                }
            }
            MenuItem {
                title: current-view == "device-console" ? @tr("âœ“ Device Console") : @tr("Device Console");
                activated => {
                    if (current-view != "device-console") {
                        current-view = "device-console";
                        root.menu-view-device-console();
                    }
                }
            }
            MenuItem {
                title: current-view == "gcode-editor" ? @tr("âœ“ G-Code Editor") : @tr("G-Code Editor");
                activated => {
                    if (current-view != "gcode-editor") {
                        current-view = "gcode-editor";
                        root.gcode-focus-trigger += 1;
                        root.menu-view-gcode-editor();
                    } else {
                        root.menu-view-gcode-editor();
                        root.gcode-focus-trigger += 1;
                    }
                }
            }
            MenuItem {
                title: current-view == "gcode-visualizer" ? @tr("âœ“ Visualizer") : @tr("Visualizer");
                activated => {
                    if (current-view != "gcode-visualizer") {
                        current-view = "gcode-visualizer";
                        root.menu-view-gcode-visualizer();
                    }
                }
            }
            MenuItem {
                title: current-view == "cam-tools" ? @tr("âœ“ CAMTools") : @tr("CAMTools");
                activated => {
                    if (current-view != "cam-tools") {
                        current-view = "cam-tools";
                    }
                }
            }
            MenuItem {
                title: current-view == "designer" ? @tr("âœ“ Designer") : @tr("Designer");
                activated => {
                    if (current-view != "designer") {
                        current-view = "designer";
                        root.menu-view-designer();
                    }
                }
            }
            MenuItem {
                title: current-view == "device-info" ? @tr("âœ“ Machine Info") : @tr("Machine Info");
                activated => {
                    if (current-view != "device-info") {
                        current-view = "device-info";
                    }
                }
            }
            MenuItem {
                title: current-view == "config-settings" ? @tr("âœ“ Device Config") : @tr("Device Config");
                activated => {
                    current-view = "config-settings";
                }
            }
            MenuItem {
                title: current-view == "device-manager" ? @tr("âœ“ Device Manager") : @tr("Device Manager");
                activated => {
                    if (current-view != "device-manager") {
                        current-view = "device-manager";
                        root.load-device-profiles();
                    }
                }
            }
            MenuItem {
                title: current-view == "cnc-tools" ? @tr("âœ“ CNCTools") : @tr("CNCTools");
                activated => {
                    if (current-view != "cnc-tools") {
                        current-view = "cnc-tools";
                        root.load_tools();
                    }
                }
            }
            MenuItem {
                title: current-view == "materials" ? @tr("âœ“ Materials") : @tr("Materials");
                activated => {
                    if (current-view != "materials") {
                        current-view = "materials";
                        root.menu-view-materials();
                    }
                }
            }
        }
        
        Menu {
            title: @tr("Help");
            MenuItem {
                title: @tr("About");
                activated => { 
                    root.menu-help-about();
                    about-dialog-visible = true;
                }
            }
        }
    }
}
